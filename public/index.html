<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App | Node.JS Express.JS SQLite</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="fanta.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <section id="auth">
        <div>
            <!-- FIXED: className → class -->
            <h2 class="sign-up-text">Login</h2>
            <p>Create an account!</p>
        </div>

        <p id="error" style="display: none;"></p>

        <input id="emailInput" placeholder="Email" />
        <input id="passwordInput" placeholder="********" type="password" />

        <button id="authBtn" onclick="authenticate()">
            Submit
        </button>

        <hr />
        <div class="register-content">
            <p>Don’t have an account?</p>
            <button onclick="toggleIsRegister()" id="registerBtn">Sign up</button>
        </div>
    </section>

    <header style="display: none;">
        <h1 class="text-gradient">You have 0 open tasks.</h1>
    </header>

    <nav style="display: none;" class="tab-container">
        <button onclick="changeTab('All')" class="tab-button selected-tab">
            <h4>All <span>(0)</span></h4>
        </button>
        <button onclick="changeTab('Open')" class="tab-button">
            <h4>Open <span>(0)</span></h4>
        </button>
        <button onclick="changeTab('Complete')" class="tab-button">
            <h4>Complete <span>(0)</span></h4>
        </button>
        <hr />
    </nav>

    <main style="display: none;"></main>

<script>
    let token = localStorage.getItem('token')

    let isLoading = false
    let isAuthenticating = false
    let isRegistration = false
    let selectedTab = 'All'
    let todos = []

    const apiBase = '/'

    // DOM elements
    const nav = document.querySelector('nav')
    const header = document.querySelector('header')
    const main = document.querySelector('main')
    const navElements = document.querySelectorAll('.tab-button')
    const authContent = document.getElementById('auth')

    // FIXED: use correct variable
    const textError = document.getElementById('error')

    const email = document.getElementById('emailInput')
    const password = document.getElementById('passwordInput')
    const registerBtn = document.getElementById('registerBtn')
    const authBtn = document.getElementById('authBtn')

    // ---------------------
    // PAGE FUNCTIONS
    // ---------------------

    async function showDashboard() {
        nav.style.display = 'block'
        header.style.display = 'flex'
        main.style.display = 'flex'
        authContent.style.display = 'none'
        await fetchTodos()
    }

    function updateHeaderText() {
        const count = todos.filter(t => !t.completed).length
        header.querySelector('h1').innerText =
            count === 1 ? "You have 1 open task." : `You have ${count} open tasks.`
    }

    function updateNavCount() {
        navElements.forEach(btn => {
            const tab = btn.innerText.split(' ')[0]
            const count = todos.filter(t => {
                if (tab === "All") return true
                if (tab === "Open") return !t.completed
                if (tab === "Complete") return t.completed
            }).length

            btn.querySelector('span').innerText = `(${count})`
        })
    }

    function changeTab(tab) {
        selectedTab = tab
        navElements.forEach(btn => {
            btn.classList.toggle("selected-tab", btn.innerText.includes(tab))
        })
        renderTodos()
    }

    function renderTodos() {
        updateNavCount()
        updateHeaderText()

        let html = ""

        todos
            .filter(t =>
                selectedTab === "All" ? true :
                selectedTab === "Complete" ? t.completed :
                !t.completed
            )
            .forEach(todo => {
                html += `
                <div class="card todo-item">
                    <p>${todo.task}</p>
                    <div class="todo-buttons">
                        <button onclick="updateTodo(${todo.id})" ${todo.completed ? "disabled" : ""}>
                            <h6>Done</h6>
                        </button>
                        <button onclick="deleteTodo(${todo.id})">
                            <h6>Delete</h6>
                        </button>
                    </div>
                </div>`
            })

        html += `
        <div class="input-container">
            <input id="todoInput" placeholder="Add task" />
            <button onclick="addTodo()">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>`

        main.innerHTML = html
    }

    // ---------------------
    // AUTHENTICATION
    // ---------------------

    function toggleIsRegister() {
        isRegistration = !isRegistration
        registerBtn.innerText = isRegistration ? "Sign in" : "Sign up"
        document.querySelector('#auth > div h2').innerText = isRegistration ? "Sign Up" : "Login"
        document.querySelector('.register-content p').innerText =
            isRegistration ? "Already have an account?" : "Don’t have an account?"
    }

    async function authenticate() {
        const emailVal = email.value
        const passVal = password.value

        if (!emailVal || !passVal || passVal.length < 6 || !emailVal.includes("@") || isAuthenticating)
            return

        textError.style.display = 'none'
        isAuthenticating = true
        authBtn.innerText = "Authenticating..."

        try {
            let response
            if (isRegistration) {
                response = await fetch(apiBase + "auth/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username: emailVal, password: passVal })
                })
            } else {
                response = await fetch(apiBase + "auth/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username: emailVal, password: passVal })
                })
            }

            const data = await response.json()

            if (data.token) {
                token = data.token
                localStorage.setItem("token", token)
                authBtn.innerText = "Loading..."
                await fetchTodos()
                showDashboard()
            } else {
                throw Error(data.message || "Authentication failed.")
            }

        } catch (err) {
            textError.innerText = err.message
            textError.style.display = "block"

        } finally {
            authBtn.innerText = "Submit"
            isAuthenticating = false
        }
    }

    // ---------------------
    // CRUD
    // ---------------------

    async function fetchTodos() {
        isLoading = true
        const res = await fetch(apiBase + "todos", {
            headers: { "Authorization": token }
        })
        todos = await res.json()
        isLoading = false
        renderTodos()
    }

    async function updateTodo(id) {
        await fetch(apiBase + "todos/" + id, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": token
            },
            body: JSON.stringify({
                task: todos.find(t => t.id === id).task,
                completed: 1
            })
        })
        fetchTodos()
    }

    async function deleteTodo(id) {
        await fetch(apiBase + "todos/" + id, {
            method: "DELETE",
            headers: { "Authorization": token }
        })
        fetchTodos()
    }

    async function addTodo() {
        const todoInput = document.getElementById("todoInput")
        const task = todoInput.value.trim()
        if (!task) return

        await fetch(apiBase + "todos", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": token
            },
            body: JSON.stringify({ task })
        })

        todoInput.value = ""
        fetchTodos()
    }

    // ---------------------
    // AUTO LOGIN
    // ---------------------

    if (token) {
        (async () => {
            await fetchTodos()
            showDashboard()
        })()
    }
</script>

</body>
</html>
